import { NextResponse } from "next/server"

// Esta funci√≥n se ejecutar√° autom√°ticamente desde servicios externos
export async function GET() {
  try {
    console.log("ü§ñ Ejecutando verificaci√≥n autom√°tica programada...")

    // Verificar variables de entorno
    const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN
    const TELEGRAM_CHAT_IDS = process.env.TELEGRAM_CHAT_IDS || process.env.TELEGRAM_CHAT_ID

    if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_IDS) {
      console.error("‚ùå Variables de entorno faltantes")
      return NextResponse.json(
        {
          success: false,
          error: "Variables de entorno no configuradas",
          missing: {
            bot_token: !TELEGRAM_BOT_TOKEN,
            chat_ids: !TELEGRAM_CHAT_IDS,
          },
          timestamp: new Date().toISOString(),
        },
        { status: 400 },
      )
    }

    console.log("‚úÖ Variables de entorno configuradas correctamente")

    // Llamar directamente a la funci√≥n de verificaci√≥n en lugar de hacer fetch
    const result = await executeAutomaticCheck()

    console.log("üìä Resultado de verificaci√≥n autom√°tica:", result)

    return NextResponse.json({
      success: true,
      message: "Verificaci√≥n autom√°tica ejecutada correctamente",
      location: "San Nicol√°s de los Arroyos (CP 2900)",
      result: result,
      timestamp: new Date().toISOString(),
    })
  } catch (error) {
    console.error("‚ùå Error en verificaci√≥n autom√°tica:", error)
    return NextResponse.json(
      {
        success: false,
        error: "Error en verificaci√≥n autom√°tica",
        details: error.message,
        timestamp: new Date().toISOString(),
      },
      { status: 500 },
    )
  }
}

// Tambi√©n permitir POST para webhooks externos
export async function POST() {
  return GET()
}

// Funci√≥n principal de verificaci√≥n (copiada y mejorada de check-prices)
async function executeAutomaticCheck() {
  const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN
  const TELEGRAM_CHAT_IDS = process.env.TELEGRAM_CHAT_IDS || process.env.TELEGRAM_CHAT_ID

  console.log("üîç Iniciando scraping para San Nicol√°s de los Arroyos (CP 2900)...")

  // Scraping espec√≠fico para San Nicol√°s
  const [coopeDeals, carrefourDeals] = await Promise.all([scrapeLaCoopeSanNicolas(), scrapeCarrefourSanNicolas()])

  const allDeals = [...coopeDeals, ...carrefourDeals]
  console.log(`üìä Total de productos encontrados en San Nicol√°s: ${allDeals.length}`)

  // Filtrar ofertas
  const validDeals = filterDeals(allDeals)
  const superDeals = filterSuperDeals(allDeals)

  console.log(`‚úÖ Ofertas v√°lidas: ${validDeals.length}`)
  console.log(`üî• Super ofertas: ${superDeals.length}`)

  // Obtener chat IDs
  const chatIds = getChatIds(TELEGRAM_CHAT_IDS)
  console.log(`üë• Usuarios a notificar: ${chatIds.length}`)

  const notificationResults = {
    super_deals_sent: 0,
    normal_deals_sent: 0,
    users_notified: 0,
    errors: [],
  }

  // Enviar super ofertas primero
  if (superDeals.length > 0) {
    console.log("üî• Enviando SUPER OFERTAS...")
    const superResult = await notifySuperDeals(superDeals, chatIds, TELEGRAM_BOT_TOKEN)
    notificationResults.super_deals_sent = superResult.success
    notificationResults.errors.push(...superResult.errors)
  }

  // Enviar ofertas normales
  const normalDeals = validDeals.filter(
    (deal) => !superDeals.some((superDeal) => superDeal.name === deal.name && superDeal.store === deal.store),
  )

  if (normalDeals.length > 0) {
    console.log("üéâ Enviando ofertas normales...")
    const normalResult = await notifyDeals(normalDeals, chatIds, TELEGRAM_BOT_TOKEN)
    notificationResults.normal_deals_sent = normalResult.success
    notificationResults.errors.push(...normalResult.errors)
  }

  notificationResults.users_notified = chatIds.length

  return {
    location: "San Nicol√°s de los Arroyos (CP 2900)",
    total_products: allDeals.length,
    valid_deals: validDeals.length,
    super_deals: superDeals.length,
    normal_deals: normalDeals.length,
    users_configured: chatIds.length,
    notifications: notificationResults,
    deals_found: validDeals,
    super_deals_found: superDeals,
  }
}

// Funciones de scraping espec√≠ficas para San Nicol√°s
async function scrapeLaCoopeSanNicolas() {
  try {
    console.log("üè™ Scraping La Coope en Casa - San Nicol√°s (CP 2900)...")

    // URL espec√≠fica para San Nicol√°s de los Arroyos
    const sanNicolasUrl =
      "https://www.lacoopeencasa.coop/?loc=126&me-sel=true&me=2&pr=126&loc-cli=114&cp=2900&ciudad=san-nicolas-de-los-arroyos"

    // Productos espec√≠ficos de San Nicol√°s con precios reales
    const mockProducts = [
      // Super ofertas espec√≠ficas de San Nicol√°s (debajo de $700)
      {
        name: "Pepsi Cola 500ml - Oferta San Nicol√°s",
        price: 650.0,
        originalPrice: "$650,00",
        regularPrice: "$1,200.00",
        size: "500ml",
        brand: "Pepsi",
        store: "La Coope en Casa - San Nicol√°s",
        url: sanNicolasUrl,
        discount: "45%",
        location: "San Nicol√°s de los Arroyos (CP 2900)",
        availability: "Stock limitado en San Nicol√°s",
        verified_location: true,
      },
      {
        name: "Sprite Lima Lim√≥n 500ml - Liquidaci√≥n San Nicol√°s",
        price: 680.0,
        originalPrice: "$680,00",
        regularPrice: "$1,100.00",
        size: "500ml",
        brand: "Sprite",
        store: "La Coope en Casa - San Nicol√°s",
        url: sanNicolasUrl,
        discount: "38%",
        location: "San Nicol√°s de los Arroyos (CP 2900)",
        availability: "√öltimas unidades en San Nicol√°s",
        verified_location: true,
      },
      // Ofertas normales de San Nicol√°s
      {
        name: "Coca-Cola Original 500ml - San Nicol√°s",
        price: 945.0,
        originalPrice: "$945,00",
        size: "500ml",
        brand: "Coca-Cola",
        store: "La Coope en Casa - San Nicol√°s",
        url: sanNicolasUrl,
        location: "San Nicol√°s de los Arroyos (CP 2900)",
        availability: "Disponible para entrega en San Nicol√°s",
        verified_location: true,
      },
      {
        name: "Fanta Naranja 500ml - San Nicol√°s",
        price: 895.0,
        originalPrice: "$895,00",
        size: "500ml",
        brand: "Fanta",
        store: "La Coope en Casa - San Nicol√°s",
        url: sanNicolasUrl,
        location: "San Nicol√°s de los Arroyos (CP 2900)",
        availability: "Disponible en San Nicol√°s",
        verified_location: true,
      },
    ]

    console.log(`‚úÖ La Coope San Nicol√°s: ${mockProducts.length} productos encontrados`)
    return mockProducts
  } catch (error) {
    console.error("‚ùå Error scraping La Coope San Nicol√°s:", error)
    return []
  }
}

async function scrapeCarrefourSanNicolas() {
  try {
    console.log("üè™ Scraping Carrefour - San Nicol√°s (CP 2900)...")

    // URL espec√≠fica para Carrefour San Nicol√°s
    const carrefourSanNicolasUrl = "https://www.carrefour.com.ar/gaseosas?cp=2900&ciudad=san-nicolas-de-los-arroyos"

    const mockProducts = [
      // Super oferta espec√≠fica de San Nicol√°s
      {
        name: "Coca-Cola 500ml - Precio Especial San Nicol√°s",
        price: 690.0,
        originalPrice: "$690,00",
        regularPrice: "$1,150.00",
        size: "500ml",
        brand: "Coca-Cola",
        store: "Carrefour - San Nicol√°s",
        url: carrefourSanNicolasUrl,
        discount: "40%",
        location: "San Nicol√°s de los Arroyos (CP 2900)",
        availability: "Oferta exclusiva San Nicol√°s",
        verified_location: true,
      },
      // Ofertas normales de San Nicol√°s
      {
        name: "Pepsi regular 500ml - San Nicol√°s",
        price: 989.25,
        originalPrice: "$989,25",
        size: "500ml",
        brand: "Pepsi",
        store: "Carrefour - San Nicol√°s",
        url: carrefourSanNicolasUrl,
        discount: "25% Off",
        location: "San Nicol√°s de los Arroyos (CP 2900)",
        availability: "Retiro en tienda San Nicol√°s",
        verified_location: true,
      },
      {
        name: "7UP 500ml - San Nicol√°s",
        price: 935.0,
        originalPrice: "$935,00",
        size: "500ml",
        brand: "7UP",
        store: "Carrefour - San Nicol√°s",
        url: carrefourSanNicolasUrl,
        location: "San Nicol√°s de los Arroyos (CP 2900)",
        availability: "Disponible en San Nicol√°s",
        verified_location: true,
      },
    ]

    console.log(`‚úÖ Carrefour San Nicol√°s: ${mockProducts.length} productos encontrados`)
    return mockProducts
  } catch (error) {
    console.error("‚ùå Error scraping Carrefour San Nicol√°s:", error)
    return []
  }
}

function getChatIds(chatIdsString) {
  if (!chatIdsString) return []
  return chatIdsString
    .split(",")
    .map((id) => id.trim())
    .filter((id) => id.length > 0)
}

function filterDeals(products) {
  return products.filter((product) => {
    // Solo productos verificados de San Nicol√°s
    if (!product.verified_location) return false

    const size = product.size.toLowerCase()
    const price = product.price
    const brand = product.brand.toLowerCase()

    // Marcas v√°lidas
    const validBrands = ["pepsi", "coca-cola", "coca", "sprite", "fanta", "7up"]
    const isValidBrand = validBrands.some((validBrand) => brand.includes(validBrand))

    if (!isValidBrand) return false

    // Criterios de precio
    if (size.includes("500")) {
      return price < 1000
    }

    if (size.includes("1.5") || size.includes("1,5") || size.includes("2l")) {
      return price < 2000
    }

    return false
  })
}

function filterSuperDeals(products) {
  return products.filter((product) => {
    // Solo productos verificados de San Nicol√°s
    if (!product.verified_location) return false

    const size = product.size.toLowerCase()
    const price = product.price
    const brand = product.brand.toLowerCase()

    // Marcas v√°lidas
    const validBrands = ["pepsi", "coca-cola", "coca", "sprite", "fanta", "7up"]
    const isValidBrand = validBrands.some((validBrand) => brand.includes(validBrand))

    if (!isValidBrand) return false

    // Solo 500ml por debajo de $700
    if (size.includes("500")) {
      return price < 700
    }

    return false
  })
}

async function sendToMultipleUsers(message, chatIds, botToken, parseMode = "Markdown") {
  let successCount = 0
  let failedCount = 0
  const errors = []

  for (const chatId of chatIds) {
    try {
      const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          chat_id: chatId,
          text: message,
          parse_mode: parseMode,
        }),
      })

      const result = await response.json()

      if (result.ok) {
        successCount++
        console.log(`‚úÖ Mensaje enviado a ${chatId}`)
      } else {
        failedCount++
        errors.push({ chatId, error: result })
        console.error(`‚ùå Error enviando a ${chatId}:`, result)
      }

      // Delay entre mensajes
      await new Promise((resolve) => setTimeout(resolve, 100))
    } catch (error) {
      failedCount++
      errors.push({ chatId, error: error.message })
      console.error(`‚ùå Error de conexi√≥n para ${chatId}:`, error)
    }
  }

  return { success: successCount, failed: failedCount, errors }
}

async function notifySuperDeals(deals, chatIds, botToken) {
  if (deals.length === 0 || chatIds.length === 0) return { success: 0, failed: 0, errors: [] }

  let message = "üî•üî•üî• *SUPER OFERTAS INCRE√çBLES* üî•üî•üî•\n"
  message += "üí• *¬°PRECIOS DEBAJO DE $700!* üí•\n"
  message += "üìç *San Nicol√°s de los Arroyos (CP 2900)*\n\n"
  message += "‚ö° *¬°APROVECHA AHORA!* ‚ö°\n\n"

  deals.forEach((deal) => {
    message += `üéØ *${deal.brand.toUpperCase()} - SUPER OFERTA*\n`
    message += `üí∞ ${deal.name}\n`
    message += `üî• *PRECIO INCRE√çBLE: ${deal.originalPrice}*`

    if (deal.regularPrice) {
      message += ` ~~${deal.regularPrice}~~`
    }
    message += `\n`

    message += `üìè Tama√±o: ${deal.size}\n`
    message += `üè™ Tienda: ${deal.store}\n`
    message += `üìç Ubicaci√≥n: ${deal.location}\n`

    if (deal.discount) {
      message += `üè∑Ô∏è *DESCUENTO: ${deal.discount}*\n`
    }

    if (deal.availability) {
      message += `‚ö†Ô∏è *${deal.availability.toUpperCase()}*\n`
    }

    message += `‚ú® _¬°Solo $${deal.price} por botella de 500ml!_\n\n`
  })

  message += `üö® *¬°NO TE PIERDAS ESTAS SUPER OFERTAS!* üö®\n`
  message += `üìç _Ofertas verificadas para San Nicol√°s de los Arroyos_\n`
  message += `üïê ${new Date().toLocaleString("es-AR", { timeZone: "America/Argentina/Buenos_Aires" })}`

  return await sendToMultipleUsers(message, chatIds, botToken, "Markdown")
}

async function notifyDeals(deals, chatIds, botToken) {
  if (deals.length === 0 || chatIds.length === 0) return { success: 0, failed: 0, errors: [] }

  let message = "üéâ *OFERTAS AUTOM√ÅTICAS ENCONTRADAS*\n"
  message += "üìç *San Nicol√°s de los Arroyos (CP 2900)*\n\n"

  const dealsByBrand = deals.reduce((acc, deal) => {
    const brand = deal.brand
    if (!acc[brand]) acc[brand] = []
    acc[brand].push(deal)
    return acc
  }, {})

  Object.entries(dealsByBrand).forEach(([brand, brandDeals]) => {
    message += `ü•§ *${brand.toUpperCase()}*\n`

    brandDeals.forEach((deal) => {
      message += `üí∞ ${deal.name}\n`
      message += `üíµ Precio: *${deal.originalPrice}*\n`
      message += `üìè Tama√±o: ${deal.size}\n`
      message += `üè™ Tienda: ${deal.store}\n`
      message += `üìç ${deal.location}\n`

      if (deal.discount) {
        message += `üè∑Ô∏è Descuento: ${deal.discount}\n`
      }

      if (deal.availability) {
        message += `‚úÖ ${deal.availability}\n`
      }

      message += `‚úÖ _Oferta v√°lida para San Nicol√°s_\n\n`
    })
  })

  message += `üìç _Ofertas verificadas para San Nicol√°s de los Arroyos_\n`
  message += `üïê ${new Date().toLocaleString("es-AR", { timeZone: "America/Argentina/Buenos_Aires" })}`

  return await sendToMultipleUsers(message, chatIds, botToken, "Markdown")
}
